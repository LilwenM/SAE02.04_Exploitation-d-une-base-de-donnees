-- Initialisation du schéma
drop schema if exists parcoursup cascade; 
create schema parcoursup;
set schema 'parcoursup';


-- Table _academie

create table _academie (
    academie_nom    varchar,
    cod_aff_form    varchar,

    constraint id_academie primary key (academie_nom)
);


-- Table _etablissement

create table _etablissement (
    etablissement_code_uai      char(8), 
    etablissement_nom           varchar, 
    etablissement_statut        varchar, 
    cod_aff_form                varchar,

    constraint id_etablissement primary key (etablissement_code_uai)
);


-- Table _filiere

create table _filiere (
    filiere_id                      int, 
    filiere_libelle                 varchar, 
    filiere_libelle_tres_abrege     varchar, 
    filiere_libelle_abrege          varchar, 
    filiere_libelle_detaille_bis    varchar, 
    cod_aff_form                    varchar     not null,

    constraint id_filiere primary key (filiere_id)
); 



-- Table _region

create table _region (
    region_nom          varchar,
    departement_code    varchar(3)  not null,

    constraint id_region primary key (region_nom)
); 


-- Table _departement

create table _departement (
    departement_code    varchar(3), 
    departement_nom     varchar, 
    region_nom          varchar     not null, 

    constraint id_departement primary key (departement_code)
); 


-- Table _commune 

create table _commune (
    commune_nom         varchar,
    departement_code    varchar(3),      
    cod_aff_form        varchar,

    constraint id_commune primary key (commune_nom, departement_code)
); 


-- Table _session

create table _session (
    session_annee   numeric(4),

    constraint id_session primary key (session_annee)
); 


-- Table _regroupement 

create table _regroupement (
    regroupement_libelle    varchar, 

    constraint id_regroupement primary key (regroupement_libelle)
); 


-- Table _mention_bac

create table _mention_bac (
    libelle_mention     varchar,

    constraint id_mention_bac primary key (libelle_mention)
); 


-- Table _type_bac

create table _type_bac (
    type_bac    varchar, 

    constraint id_type_bac primary key (type_bac)
); 


-- Table _formation

create table _formation (
    cod_aff_form                        varchar, 
    filiere_libelle_detaille            varchar, 
    coordonnees_gps                     varchar, 
    list_com                            varchar, 
    concours_communs_banque_epreuve     varchar, 
    url_formation                       varchar, 
    tri                                 varchar,
    filiere_id                          int         not null,
    academie_nom                        varchar     not null,
    etablissement_code_uai              char(8)     not null,

    constraint id_formation primary key (cod_aff_form)
);


-- Table association (_session , _regroupement , _formation)
-- Table _rang_dernier_appele_selon_regroupement

create table _rang_dernier_appele_selon_regroupement (
    session_annee                       numeric(4),
    cod_aff_form                        varchar,
    regroupement_libelle                varchar,
    rang_dernier_appele                 int,

    constraint id_rang_dernier_appele_selon_regroupement primary key (session_annee, regroupement_libelle, cod_aff_form) 
); 


-- Table assiciation (_session , _type_bac , _formation)
-- Table _admissions_selon_type_nea_bac

create table _admissions_selon_type_neo_bac (
    session_annee                       numeric(4),
    type_bac                            varchar,
    cod_aff_form                        varchar,
    effectif_candidat_neo_bac_classes   int, 
    
    constraint id_admissions_selon_type_neo_bac primary key (session_annee, type_bac, cod_aff_form)
); 


-- Table association (_session , _mention_bac , _formation)
-- Table _effectif_selon_mention

create table _effectif_selon_mention (
    session_annee                           numeric(4),
    libelle_mention                         varchar,
    cod_aff_form                            varchar,
    effectif_admis_neo_bac_selon_mention    int, 
    
    constraint id_effectif_selon_mention primary key (session_annee, libelle_mention, cod_aff_form)
);  


-- Table association (_session , _formation)
-- Table _admissions_generalites

create table _admissions_generalites (
    session_annee               numeric(4),
    cod_aff_form                varchar     not null, 
    selectivite                 varchar,
    capacite                    int, 
    effectif_total_candidats    int,
    effectif_total_candidates   int,

    constraint id_admissions_generalites primary key (session_annee, cod_aff_form)
); 




-- Ajouts des contraintes de clé étrangères 

alter table _region
    add constraint _region_fk
        foreign key (departement_code) references _departement(departement_code); 


alter table _departement 
    add constraint _departement_fk
        foreign key (region_nom) references _region(region_nom); 


alter table _commune
    add constraint _commune_fk1
        foreign key (departement_code) references _departement(departement_code), 
    add constraint _commune_fk2
        foreign key (cod_aff_form) references _formation(cod_aff_form); 


alter table _academie
    add constraint _academie_fk
        foreign key (cod_aff_form) references _formation(cod_aff_form); 


alter table _etablissement
    add constraint _etablissment_fk 
        foreign key (cod_aff_form) references _formation(cod_aff_form); 


alter table _filiere
    add constraint _filiere_fk 
        foreign key (cod_aff_form) references _formation(cod_aff_form); 


alter table _formation 
    add constraint _formation_fk1
        foreign key (filiere_id) references _filiere(filiere_id),
    add constraint _formation_fk2
        foreign key (academie_nom) references _academie(academie_nom),
    add constraint _formation_fk3
        foreign key (etablissement_code_uai) references _etablissement(etablissement_code_uai);


alter table _rang_dernier_appele_selon_regroupement
    add constraint _rang_dernier_appele_selon_regroupement_fk1 
        foreign key (session_annee) references _session(session_annee), 
    add constraint _rang_dernier_appele_selon_regroupement_fk2 
        foreign key (regroupement_libelle) references _regroupement(regroupement_libelle), 
    add constraint _rang_dernier_appele_selon_regroupement_fk3 
        foreign key (cod_aff_form) references _formation(cod_aff_form); 

alter table _admissions_selon_type_neo_bac
    add constraint _admissions_selon_type_neo_bac_fk1 
        foreign key (session_annee) references _session(session_annee), 
    add constraint _admissions_selon_type_neo_bac_fk2 
        foreign key (type_bac) references _type_bac(type_bac), 
    add constraint _admissions_selon_type_neo_bac_fk3 
        foreign key (cod_aff_form) references _formation(cod_aff_form); 


alter table _effectif_selon_mention
    add constraint _effectif_selon_mention_fk1 
        foreign key (session_annee) references _session(session_annee), 
    add constraint _effectif_selon_mention_fk2 
        foreign key (libelle_mention) references _mention_bac(libelle_mention), 
    add constraint _effectif_selon_mention_fk3 
        foreign key (cod_aff_form) references _formation(cod_aff_form);


alter table _admissions_generalites 
    add constraint _admissions_generalites_fk1 
        foreign key (session_annee) references _session(session_annee), 
    add constraint _admissions_generalites_fk2 
        foreign key (cod_aff_form) references _formation(cod_aff_form); 


commit;